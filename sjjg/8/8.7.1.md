# 外部排序
## 外存与内存之间的数据交换
操作系统以“块”为单位对磁盘存储空间进行管理，如：每块大小 1KB各个磁盘块內存放着各种各样的数据
磁盘的读/写以“块”为单位
数据读入内存后才能被修改
修改完了还要写回磁盘
## 外部排序的原理
外部排序：数据元素太多，无法一次全部读入内存进行排序
使用“归并排序"的方法，最少只需在内存中分配3块大小的缓冲区即可对任意一个大文件进行排序

### 构造初始“归并段”
“归并排序”要求各个子序列有序，每次读入两个块的内容(进入输入缓冲区1)，进行内部排序后（通过输出缓冲区）写回磁盘（磁盘多了一个有序的“归并段”）。

e.g.
16块的磁盘块
`构造初始归并段`：需要16次“读”和16次“写”:32次的磁盘读取，初始化构造时，两个块并为一个归并段
第一趟归并：把8个有序子序列（初始归并段）两两归并——参考归并排序算法，先读各个端中的开头的部分，分别到内存的输入缓冲区1和输出缓冲区2。
然后对比排序排入输出缓冲区，凑成一个块然后输出；然后再按成一个块，如果输入缓冲区x为空了，立即读入磁盘中的对应段x的剩余数据（可以参考操作系统的缓冲区的处理）
那么两个归并段就变成一个归并段了。
`8->4` -> 需要16次“读”和16次“写”
`4->2` -> 需要16次“读”和16次“写”
`2->1` -> 需要16次“读”和16次“写”
采用4路归并，只需进行两趟归并即可读、写磁盘次数=32+32*`3`=128次 👍🏻

## 影响外部排序效率的因素
外部排序时间开销=读写外存的时间+内部排序所需时间+内部归并所需时间

## 优化思路
优化：`多路归并`
2路变4路，那么原来一次16->8，就变成16->4，然后4->有序文件

采用4路归并，只需进行两趟归并即可读、写磁盘次数=32+32*`2`=96次 👍🏻

重要结论：采用多路归并可以减少归并趟数，从而减少磁盘1/0(读写)次数

对「个初始归并段，做k路归并，则归并树可用k 叉树表示
若树高为h，则归并趟数= (h-1)最小 = log(k)r 向下取整

k越大，r越小，归并趟数越少，读写磁盘次数越少

多路归并带来的负面影响：
①k路归并时，需要开辟k个输入缓冲区，内存开销增加。
②每挑选一个关键字需要对比关键字(k-1）次，内部归并所需时间增加

生成初始归并段的“内存工作区”越大，初始归并段越长
结论：若能增加初始归并段的长度（单个输入缓冲区的宽度），则可减少初试归并段数量 r

注：按照本节介绍的方法生成的初始归并段，若共N个记录，内存工作区可以容纳L个记录，则初始归并段数量r=N/L（被内存工作区限制了！利用败者树+置换选择排序可以突破这个限制！）

## 纠正：什么是多路平衡归并？
误：对个初始归并段，做k路平衡归并，归并树可用严格k叉树（即只有度为k与度为0的结点的k叉树）来表示。

k路平衡归并：
①最多只能有k个段归并为一个；
②每一趟归并中，若有m个归并段参与归并，则经过这一趟处理得到m/k向上取证新的归并段

e.g. 8个段，4路归并，那么生成2个归并段，如果生成别的数量的，就不是4路平衡归并了！

4路归并不一定是平衡归并！比如8个段，其中两个->1,两个->1，四个->1（这里证明了是四路归并！），生成了3个归并段！